class GameConfig{constructor(){this.api={baseUrl:this.getApiUrl(),timeout:1e4,retryAttempts:3},this.leaderboard={maxEntries:10,refreshInterval:3e4,autoRefresh:!0},this.game={debug:!1,analytics:!0}}getApiUrl(){if(window.GAME_CONFIG&&window.GAME_CONFIG.API_URL)return window.GAME_CONFIG.API_URL;const e=window.location.hostname;return"localhost"===e||"127.0.0.1"===e||e.includes("stg-saasboomiorg-staging.kinsta.cloud"),"./api"}getApiEndpoint(e){return`${this.api.baseUrl}/${e}`}isDevelopment(){const e=window.location.hostname;return"localhost"===e||"127.0.0.1"===e}isStaging(){return window.location.hostname.includes("stg-saasboomiorg-staging.kinsta.cloud")}isProduction(){return"saasboomi.org"===window.location.hostname}logConfig(){(this.game.debug||this.isDevelopment())&&(console.group("üéÆ Game Configuration"),console.log("Environment:",this.getEnvironment()),console.log("API Base URL:",this.api.baseUrl),console.log("Debug Mode:",this.game.debug),console.log("Auto Refresh:",this.leaderboard.autoRefresh),console.groupEnd())}getEnvironment(){return this.isDevelopment()?"development":this.isStaging()?"staging":this.isProduction()?"production":"unknown"}}const gameConfig=new GameConfig;gameConfig.logConfig(),window.GameConfig=gameConfig;class Leaderboard{constructor(e=null){const t=window.GAME_CONFIG||{API_URL:"./api",MAX_LEADERBOARD_ENTRIES:10};this.maxEntries=t.MAX_LEADERBOARD_ENTRIES,this.apiUrl=e||t.API_URL,this.scores=[],this.loadScores()}async loadScores(){try{const e=await fetch(`${this.apiUrl}/leaderboard`);if(!e.ok)throw new Error("Failed to fetch leaderboard");const t=await e.json();this.scores=t.success?t.data:[]}catch(e){console.error("Error loading leaderboard:",e),this.scores=[]}}async getTopPlayer(){try{const e=await fetch(`${this.apiUrl}/top-player`),t=await e.json();return t.success?{success:!0,topPlayer:t.data.top_player,topScore:t.data.top_score,achievedAt:t.data.achieved_at}:(console.error("Failed to fetch top player:",t.error),{success:!1,topPlayer:null,topScore:0})}catch(e){return console.error("Error fetching top player:",e),{success:!1,topPlayer:null,topScore:0}}}async addScoreWithRecordCheck(e,t="Anonymous",i=1,s=null,n=null){const a=await this.getTopPlayer(),o=a.success&&e>a.topScore;return{...await this.addScore(e,t,i,s,n),newRecord:o,previousTopScore:a.topScore,previousTopPlayer:a.topPlayer}}async addScore(e,t="Anonymous",i=1,s=null,n=null){if(!0===window.submitLock)return;window.submitLock=!0;const a={player_name:t.trim()||"Anonymous",score:e,level:i};s&&s.trim()&&(a.email=s.trim()),n&&n.trim()&&(a.phone=n.trim());try{const e=await fetch(`${this.apiUrl}/submit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!e.ok)throw new Error("Failed to submit score");const t=await e.json();if(t.success)return window.submitLock=!1,await this.loadScores(),{madeLeaderboard:t.data.made_top_10,position:t.data.position,isNewRecord:t.data.is_new_record,result:t.data};throw window.submitLock=!1,new Error(t.error||"Failed to submit score")}catch(e){return console.error("Error submitting score:",e),{madeLeaderboard:!1,error:e.message}}}getTopScores(e=this.maxEntries){return this.scores.slice(0,Math.min(e,this.scores.length))}getHighScore(){return this.scores.length>0?this.scores[0].score:0}wouldMakeLeaderboard(e){return this.scores.length<this.maxEntries||e>this.scores[this.scores.length-1].score}calculatePosition(e){const t=[...this.scores];t.push({score:e,player_name:"TEMP"}),t.sort(((e,t)=>t.score-e.score));const i=t.findIndex((e=>"TEMP"===e.player_name))+1;return{position:i,madeLeaderboard:i<=this.maxEntries,isNewRecord:0===this.scores.length||e>this.scores[0].score}}clearScores(){this.scores=[],this.loadScores()}saveScores(){console.log("saveScores() called - scores are now automatically saved via API")}async getStatistics(){try{const e=await fetch(`${this.apiUrl}/stats`),t=await e.json();return t.success?t.data:(console.error("Failed to fetch statistics:",t.error),this.getLocalStatistics())}catch(e){return console.error("Error fetching statistics:",e),this.getLocalStatistics()}}getLocalStatistics(){if(0===this.scores.length)return{total_scores:0,average_score:0,highest_score:0,highest_level:0,unique_players:0,active_days:0};const e=this.scores.reduce(((e,t)=>e+t.score),0),t=Math.max(...this.scores.map((e=>e.score))),i=Math.max(...this.scores.map((e=>e.level||1))),s=new Set(this.scores.map((e=>e.player_name))).size;return{total_scores:this.scores.length,average_score:Math.round(e/this.scores.length),highest_score:t,highest_level:i,unique_players:s,active_days:1}}formatScore(e){return e.toString().padStart(6,"0")}formatDate(e){const t=new Date(e);return t.toLocaleDateString()+" "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}}class LeaderboardUI{constructor(e,t){this.leaderboard=e,this.gameCoordinator=t,this.createThreePanelLayout(),this.setupEventListeners(),this.startAutoRefresh()}createThreePanelLayout(){this.appContainer=document.createElement("div"),this.appContainer.className="app-container",this.appContainer.innerHTML='\n      \x3c!-- Left Panel - Branding --\x3e\n      <div class="left-panel">\n        <div class="brand-logo" id="brand-logo">\n          <div class="brand-logo-text">üéÆ</div>\n        </div>\n        <div class="brand-content">\n          <h1 class="brand-title">PACMAN<br/>ARENA</h1>\n          <p class="brand-subtitle">The Ultimate Gaming Experience</p>\n          <p class="brand-description">Join thousands of players competing for the highest score in this classic arcade adventure!</p>\n          <a href="#" class="cta-button" id="main-page-cta">Visit Our Site</a>\n        </div>\n      </div>\n\n      \x3c!-- Center Panel - Game --\x3e\n      <div class="center-panel" id="center-panel">\n        \x3c!-- Game content will be moved here --\x3e\n      </div>\n\n      \x3c!-- Right Panel - Leaderboard --\x3e\n      <div class="right-panel">\n        <div class="leaderboard-panel">\n          <div class="leaderboard-panel-header">\n            <h2>üèÜ TOP PLAYERS</h2>\n          </div>\n          <div class="leaderboard-panel-content">\n            <div class="leaderboard-panel-list" id="panel-leaderboard-list">\n              \x3c!-- Scores will be populated here --\x3e\n            </div>\n            <div class="leaderboard-panel-footer">\n              <div class="panel-stats" id="panel-leaderboard-stats">\n                \x3c!-- Stats will be populated here --\x3e\n              </div>\n              <button id="clear-panel-leaderboard" class="clear-panel-button">Clear All Scores</button>\n            </div>\n          </div>\n        </div>\n      </div>\n    ',this.createNameInputModal(),this.moveGameToLayout()}moveGameToLayout(){const e=document.body.innerHTML;document.body.innerHTML="",document.body.appendChild(this.appContainer);const t=document.createElement("div");t.innerHTML=e;const i=document.getElementById("center-panel");["main-menu-container","paused-text","game-ui","left-cover","right-cover","loading-container","error-message"].forEach((e=>{const s=t.querySelector(`#${e}`);s&&i.appendChild(s)}));t.querySelectorAll("script").forEach((e=>{document.body.appendChild(e)})),document.body.appendChild(this.nameInputModal),setTimeout((()=>{this.appContainer.classList.add("game-loaded")}),100)}createNameInputModal(){this.nameInputModal=document.createElement("div"),this.nameInputModal.id="name-input-modal",this.nameInputModal.className="name-input-modal",this.nameInputModal.innerHTML='\n      <div class="name-input-content">\n        <div class="name-input-header">\n          <h3>üéâ NEW HIGH SCORE! üéâ</h3>\n        </div>\n        <div class="name-input-body">\n          <p>Your Score: <span id="final-score"></span></p>\n          <p>Level Reached: <span id="final-level"></span></p>\n          <p id="leaderboard-position"></p>\n          <div class="input-group">\n            <label for="player-name">Enter Your Name:</label>\n            <input type="text" id="player-name" maxlength="15" placeholder="Anonymous" />\n          </div>\n          <div class="recaptcha-group">\n            <div id="recaptcha-container" class="g-recaptcha" data-sitekey="6LdbIporAAAAAOH0Ci6nGXjsVU53YiLkfE3pkt2N"></div>\n          </div>\n        </div>\n        <div class="name-input-footer">\n          <button id="submit-score" class="submit-button">Submit Score</button>\n          <button id="skip-name" class="skip-button">Skip</button>\n        </div>\n      </div>\n    '}setupEventListeners(){document.getElementById("main-page-cta")?.addEventListener("click",(e=>{e.preventDefault(),window.open("https://your-main-website.com","_blank")})),document.getElementById("clear-panel-leaderboard")?.addEventListener("click",(()=>{this.clearLeaderboard()})),document.getElementById("submit-score")?.addEventListener("click",(()=>{this.submitScore()})),document.getElementById("skip-name")?.addEventListener("click",(()=>{this.submitScore("Anonymous")})),document.getElementById("player-name")?.addEventListener("keypress",(e=>{"Enter"===e.key&&this.submitScore()})),this.nameInputModal?.addEventListener("click",(e=>{e.target,this.nameInputModal}))}startAutoRefresh(){this.updateLeaderboardPanel(),setInterval((()=>{this.updateLeaderboardPanel()}),3e4)}updateLeaderboardPanel(){const e=document.getElementById("panel-leaderboard-list"),t=document.getElementById("panel-leaderboard-stats");if(!e||!t)return;const i=this.leaderboard.getTopScores(10),s=this.leaderboard.getStatistics();0===i.length?e.innerHTML='<div class="panel-no-scores">No scores yet!<br/>Be the first to play!</div>':e.innerHTML=i.map(((e,t)=>`\n        <div class="panel-score-entry ${0===t?"first-place":""}">\n          <span class="rank">${t+1}</span>\n          <span class="name">${this.escapeHtml(e.player_name||e.name||"Anonymous")}</span>\n          <span class="score">${this.formatPanelScore(e.score)}</span>\n        </div>\n      `)).join(""),s.totalGames>0?t.innerHTML=`\n        <h4>Game Statistics</h4>\n        <div class="panel-stat-row">\n          <span>Games Played:</span>\n          <span>${s.totalGames}</span>\n        </div>\n        <div class="panel-stat-row">\n          <span>Average Score:</span>\n          <span>${this.formatPanelScore(s.averageScore)}</span>\n        </div>\n        <div class="panel-stat-row">\n          <span>Best Level:</span>\n          <span>${s.highestLevel}</span>\n        </div>\n      `:t.innerHTML='\n        <h4>Game Statistics</h4>\n        <div class="panel-stat-row">\n          <span>No games played yet</span>\n          <span>üéÆ</span>\n        </div>\n      '}formatPanelScore(e){return e>=1e6?(e/1e6).toFixed(1)+"M":e>=1e3?(e/1e3).toFixed(1)+"K":e.toString()}showNameInput(e,t){document.getElementById("final-score").textContent=this.leaderboard.formatScore(e),document.getElementById("final-level").textContent=t;const i=this.leaderboard.addScore(e,"TEMP",t);document.getElementById("leaderboard-position").textContent=i.isNewRecord?"ü•á NEW RECORD!":`#${i.position} on the leaderboard!`,this.leaderboard.scores=this.leaderboard.scores.filter((e=>"TEMP"!==(e.player_name||e.name))),this.nameInputModal.style.display="flex",setTimeout((()=>{this.nameInputModal.classList.add("show"),document.getElementById("player-name").focus(),this.renderRecaptcha()}),10),this.pendingScore=e,this.pendingLevel=t}async submitScore(e=null){const t=document.getElementById("player-name"),i=e||t.value.trim()||"Anonymous";if(this.clearRecaptchaError(),"Anonymous"===e)return void this.processScoreSubmission(i);const s=grecaptcha.getResponse();if(!s)return void this.showRecaptchaError("Please complete the reCAPTCHA verification.");const n=document.getElementById("submit-score"),a=n.textContent;n.disabled=!0,n.textContent="Verifying...";try{await this.verifyRecaptcha(s)?this.processScoreSubmission(i):(this.showRecaptchaError("reCAPTCHA verification failed. Please try again."),grecaptcha.reset())}catch(e){console.error("reCAPTCHA verification error:",e),this.showRecaptchaError("Verification failed. Please try again."),grecaptcha.reset()}finally{n.disabled=!1,n.textContent=a}}processScoreSubmission(e){const t=document.getElementById("player-name");this.leaderboard.addScore(this.pendingScore,e,this.pendingLevel);this.nameInputModal.classList.remove("show"),setTimeout((()=>{this.nameInputModal.style.display="none",t.value="","undefined"!=typeof grecaptcha&&grecaptcha.reset()}),300),this.updateLeaderboardPanel(),this.pendingScore=null,this.pendingLevel=null}clearLeaderboard(){confirm("Are you sure you want to clear all scores? This cannot be undone.")&&(this.leaderboard.clearScores(),this.updateLeaderboardPanel())}updateBranding(e){const t={logo:"üéÆ",title:"PACMAN<br/>ARENA",subtitle:"The Ultimate Gaming Experience",description:"Join thousands of players competing for the highest score in this classic arcade adventure!",ctaText:"Visit Our Site",ctaUrl:"https://your-main-website.com",...e},i=document.querySelector(".brand-logo-text");i&&(t.logoImage?i.innerHTML=`<img src="${t.logoImage}" alt="Logo" />`:i.textContent=t.logo);const s=document.querySelector(".brand-title");s&&(s.innerHTML=t.title);const n=document.querySelector(".brand-subtitle");n&&(n.textContent=t.subtitle);const a=document.querySelector(".brand-description");a&&(a.textContent=t.description);const o=document.getElementById("main-page-cta");o&&(o.textContent=t.ctaText,o.href=t.ctaUrl)}renderRecaptcha(){if("undefined"!=typeof grecaptcha&&grecaptcha.render){const e=document.getElementById("recaptcha-container");if(e&&!e.hasChildNodes())try{grecaptcha.render("recaptcha-container",{sitekey:"6LdbIporAAAAAOH0Ci6nGXjsVU53YiLkfE3pkt2N"})}catch(e){console.error("Error rendering reCAPTCHA:",e)}}else setTimeout((()=>this.renderRecaptcha()),500)}async verifyRecaptcha(e){try{const t=await fetch("api/leaderboard-api.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"verify_recaptcha",recaptcha_response:e})});if(!t.ok)throw new Error("Network response was not ok");return!0===(await t.json()).success}catch(e){return console.error("reCAPTCHA verification error:",e),!1}}showRecaptchaError(e){this.clearRecaptchaError();const t=document.querySelector(".recaptcha-group");if(t){const i=document.createElement("div");i.className="recaptcha-error",i.textContent=e,t.appendChild(i)}}clearRecaptchaError(){const e=document.querySelector(".recaptcha-error");e&&e.remove()}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}class PageRightLeaderboardUI{constructor(e,t){this.leaderboard=e,this.gameCoordinator=t,this.createLeaderboardInPageRight(),this.createNameInputModal(),this.setupEventListeners(),this.startAutoRefresh()}createLeaderboardInPageRight(){const e=document.querySelector(".page-right");e?(e.style.cssText="\n      background: linear-gradient(135deg, #000 0%, #1a1a2e 50%, #16213e 100%);\n      border-left: 3px solid #2121ff;\n      padding: 20px;\n      box-shadow: -5px 0 20px rgba(33, 33, 255, 0.3);\n      overflow-y: auto;\n      position: relative;\n    ",e.innerHTML='\n  <div class="leaderboard-panel">\n    \x3c!-- Global Champion Section --\x3e\n    <div class="global-champion-section" id="global-champion" style="\n      background: linear-gradient(135deg, #ffd700, #ffed4e);\n      border: 3px solid #b8860b;\n      border-radius: 15px;\n      padding: 15px;\n      text-align: center;\n      margin-bottom: 20px;\n      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);\n    ">\n      <div class="crown" style="font-size: 24px; margin-bottom: 5px;">üëë</div>\n      <div class="champion-title" style="\n        font-size: 12px;\n        font-weight: bold;\n        color: #b8860b;\n        text-transform: uppercase;\n        margin-bottom: 8px;\n        letter-spacing: 1px;\n        font-family: \'Courier New\', monospace;\n      ">GLOBAL CHAMPION</div>\n      <div class="champion-name" id="champion-name" style="\n        font-size: 14px;\n        font-weight: bold;\n        color: #8b4513;\n        margin-bottom: 5px;\n        font-family: \'Courier New\', monospace;\n      ">Loading...</div>\n      <div class="champion-score" id="champion-score" style="\n        font-size: 16px;\n        font-weight: bold;\n        color: #b8860b;\n        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);\n        font-family: \'Courier New\', monospace;\n      ">-</div>\n    </div>\n\n    <div class="leaderboard-panel-header">\n      <h2 style="\n        color: #ffdf00;\n        margin: 0 0 20px 0;\n        font-family: \'Courier New\', monospace;\n        font-weight: bold;\n        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);\n        text-align: center;\n        font-size: 18px;\n      ">üèÜ TOP PLAYERS</h2>\n    </div>\n\n    <div class="leaderboard-panel-content">\n      <div class="leaderboard-panel-list" id="panel-leaderboard-list" style="\n        margin-bottom: 20px;\n        min-height: 300px;\n      ">\n        \x3c!-- Scores will be populated here --\x3e\n      </div>\n    </div>\n  </div>\n  <div class="right-bottom">\n        <div class="terms-and-conditions">\n          <h3>Terms and Conditions:</h3>\n          <ul>\n            <li>\n              You must be a SaaSBoomi Compass member or have passed Caravan ‚Äô25 curation with a valid payment link. Not a member? <a target="_blank" href="https://compass.saasboomi.org/" style="color: #ffdf00;">Join here.</a>\n\n            </li>\n            <li>Winners will be contacted via email.</li>\n            <li>\n              If a winner is not eligible, the next top scorer will take their\n              place.\n            </li>\n          </ul>\n        </div>\n\n        <div class="share-score">\n         \n        </div>\n      </div>\n'):console.error("page-right div not found!")}createNameInputModal(){this.nameInputModal=document.createElement("div"),this.nameInputModal.id="name-input-modal",this.nameInputModal.style.cssText="\n      display: none;\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background-color: rgba(0, 0, 0, 0.8);\n      justify-content: center;\n      align-items: center;\n      z-index: 1000;\n      opacity: 0;\n      transition: opacity 0.3s ease;\n    ",this.nameInputModal.innerHTML='\n      <div class="name-input-content" style="\n        background-color: #000;\n        border: 5px solid #2121ff;\n        border-radius: 10px;\n        padding: 20px;\n        max-width: 400px;\n        width: 90%;\n        box-shadow: 0 0 20px rgba(33, 33, 255, 0.5);\n        transform: scale(0.8);\n        transition: transform 0.3s ease;\n        text-align: center;\n        font-family: \'Courier New\', monospace;\n      ">\n        <div class="name-input-header">\n          <h3 style="\n            color: #ffdf00;\n            margin: 0 auto 20px auto;\n            animation: pulse 1s infinite;\n          ">üéâ NEW HIGH SCORE! üéâ</h3>\n        </div>\n        <div class="name-input-body">\n          <p style="color: #fff; margin: 10px 0;">Your Score: <span id="final-score" style="color: #00ff00; font-weight: bold;"></span></p>\n          <p style="color: #fff; margin: 10px 0;">Level Reached: <span id="final-level" style="color: #00ff00; font-weight: bold;"></span></p>\n          <p id="leaderboard-position" style="color: #ffdf00; font-weight: bold; font-size: 1.1em; margin: 15px 0;"></p>\n          <div class="input-group" style="margin: 20px 0;">\n            <label for="player-name" style="\n              display: block;\n              color: #ffdf00;\n              margin-bottom: 5px;\n            ">Enter Your Name (required):</label>\n            <input type="text" id="player-name" maxlength="50" placeholder="Your name" required style="\n              width: 100%;\n              padding: 10px;\n              border: 2px solid #2121ff;\n              border-radius: 5px;\n              background-color: #000;\n              color: #fff;\n              font-family: \'Courier New\', monospace;\n              font-size: 16px;\n              text-align: center;\n              box-sizing: border-box;\n              margin-bottom: 15px;\n            " />\n            \n            <label for="player-email" style="\n              display: block;\n              color: #ffdf00;\n              margin-bottom: 5px;\n            ">Email (required):</label>\n            <input type="email" id="player-email" maxlength="255" required placeholder="your@email.com" style="\n              width: 100%;\n              padding: 10px;\n              border: 2px solid #2121ff;\n              border-radius: 5px;\n              background-color: #000;\n              color: #fff;\n              font-family: \'Courier New\', monospace;\n              font-size: 16px;\n              text-align: center;\n              box-sizing: border-box;\n              margin-bottom: 15px;\n            " />\n            \n            <label for="player-phone" style="\n              display: block;\n              color: #ffdf00;\n              margin-bottom: 5px;\n            ">Phone (required):</label>\n            <input type="tel" id="player-phone" maxlength="20" required placeholder="+1 123 456 7890" style="\n              width: 100%;\n              padding: 10px;\n              border: 2px solid #2121ff;\n              border-radius: 5px;\n              background-color: #000;\n              color: #fff;\n              font-family: \'Courier New\', monospace;\n              font-size: 16px;\n              text-align: center;\n              box-sizing: border-box;\n            " />\n            \n            <p style="font-size: 12px; color: #ccc; margin-top: 15px; line-height: 1.4; text-align: center;">\n              üèÜ Winners will be contacted via email<br>\n              üì± Phone helps us reach you faster\n            </p>\n          </div>\n        </div>\n        <div class="name-input-footer" style="\n          display: flex;\n          justify-content: center;\n          gap: 15px;\n          margin-top: 20px;\n        ">\n          <button id="submit-score" style="\n            background-color: #fcc73f;\n            border: 3px solid #231f20;\n            border-radius: 8px;\n            color: #231f20;\n            cursor: pointer;\n            font-family: \'Courier New\', monospace;\n            font-size: 16px;\n            font-weight: bold;\n            padding: 10px 20px;\n            transition: all 0.2s ease;\n            box-shadow: 3px 3px #ee2a29;\n          ">Submit Score</button>\n          <button id="skip-name" style="\n            background-color: #666;\n            color: #fff;\n            border: 3px solid #444;\n            border-radius: 8px;\n            cursor: pointer;\n            font-family: \'Courier New\', monospace;\n            font-size: 16px;\n            font-weight: bold;\n            padding: 10px 20px;\n            transition: all 0.2s ease;\n            box-shadow: 3px 3px #444;\n          ">Skip</button>\n        </div>\n      </div>\n    ',document.body.appendChild(this.nameInputModal)}setupEventListeners(){document.getElementById("clear-panel-leaderboard")?.addEventListener("click",(()=>{this.clearLeaderboard()})),document.getElementById("submit-score")?.addEventListener("click",(()=>{this.submitScore()})),document.getElementById("skip-name")?.addEventListener("click",(()=>{this.submitScore("Anonymous")})),document.getElementById("player-name")?.addEventListener("keypress",(e=>{"Enter"===e.key&&this.submitScore()}));const e=document.getElementById("player-name"),t=document.getElementById("player-email"),i=document.getElementById("player-phone");e&&(e.addEventListener("focus",(()=>{e.classList.add("input-highlight-yellow"),e.classList.remove("input-highlight-blue")})),e.addEventListener("blur",(()=>{e.classList.add("input-highlight-blue"),e.classList.remove("input-highlight-yellow")})),e.addEventListener("input",(()=>{this.clearFieldValidationError("player-name")}))),t&&t.addEventListener("input",(()=>{this.clearFieldValidationError("player-email")})),i&&i.addEventListener("input",(()=>{this.clearFieldValidationError("player-phone")}))}async startAutoRefresh(){const e=window.GAME_CONFIG||{AUTO_REFRESH_ENABLED:!0,REFRESH_INTERVAL_MS:3e4};await this.leaderboard.loadScores(),this.updateLeaderboardPanel(),this.updateGlobalChampion(),e.AUTO_REFRESH_ENABLED&&setInterval((async()=>{await this.leaderboard.loadScores(),this.updateLeaderboardPanel(),this.updateGlobalChampion()}),e.REFRESH_INTERVAL_MS)}updateLeaderboardPanel(){const e=document.getElementById("panel-leaderboard-list");if(!e)return;const t=this.leaderboard.getTopScores(10);0===t.length?e.innerHTML="\n        <div style=\"\n          text-align: center;\n          color: #888;\n          font-style: italic;\n          padding: 40px 20px;\n          font-family: 'Courier New', monospace;\n        \">No scores yet!<br/>Be the first to play!</div>\n      ":e.innerHTML=t.map(((e,t)=>{const i=0===t;return`\n            <div style="\n              display: grid;\n              grid-template-columns: 30px 1fr 80px;\n              gap: 8px;\n              padding: 8px 0;\n              border-bottom: 1px solid #333;\n              color: #fff;\n              font-family: 'Courier New', monospace;\n              align-items: center;\n              font-size: 12px;\n              ${i?"background: linear-gradient(90deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 215, 0, 0) 100%); border-left: 4px solid #ffdf00; padding-left: 6px;":""}\n            ">\n              <div style="\n                font-weight: bold;\n                text-align: center;\n                color: ${i?"#ffd700":"#ffdf00"};\n                ${i?"text-shadow: 0 0 10px #ffd700;":""}\n              ">${t+1}</div>\n              <div style="\n                font-weight: bold;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n              ">${this.escapeHtml(e.player_name||e.name||"Anonymous")}</div>\n              <div style="\n                text-align: right;\n                font-weight: bold;\n                color: #00ff00;\n              ">${this.leaderboard.formatScore(e.score)}</div>\n            </div>\n      \n          `})).join("")}showNameInput(e,t){console.log("showNameInput called with score:",e,"level:",t);const i=this.leaderboard.calculatePosition(e);document.getElementById("final-score").textContent=this.leaderboard.formatScore(e),document.getElementById("final-level").textContent=t;const s=document.getElementById("leaderboard-position");i.madeLeaderboard?i.isNewRecord?s.textContent="ü•á NEW RECORD!":s.textContent=`New #${i.position} high score!`:s.textContent=`Your score: ${this.leaderboard.formatScore(e)} points!`,s.classList.remove("game-element-hidden"),s.classList.add("game-element-visible"),this.nameInputModal.style.display="flex",setTimeout((()=>{this.nameInputModal.style.opacity="1",this.nameInputModal.querySelector(".name-input-content").style.transform="scale(1)"}),10),setTimeout((()=>{const e=document.getElementById("player-name");e&&e.focus()}),300),this.pendingScore={score:e,level:t}}async submitScore(e){if(console.log("submitScore called with name:",e),console.log("pendingScore:",this.pendingScore),!this.pendingScore)return void console.error("No pending score to submit");const t=e||document.getElementById("player-name")?.value?.trim()||"Anonymous",i=document.getElementById("player-email")?.value?.trim()||null,s=document.getElementById("player-phone")?.value?.trim()||null;if(this.clearValidationErrors(),!t||"Anonymous"===t)return void this.showValidationError("player-name","Name is required for score submission!");if(!i)return void this.showValidationError("player-email","Email is required for score submission!");if(!s)return void this.showValidationError("player-phone","Phone number is required for score submission!");if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i))return void this.showValidationError("player-email","Please enter a valid email address!");console.log("Final player info:",{playerName:t,email:i,phone:s});const n=await this.leaderboard.addScoreWithRecordCheck(this.pendingScore.score,t,this.pendingScore.level,i,s);console.log("Score added, result:",n),n.newRecord&&this.showNewRecordCelebration(t,this.pendingScore.score),this.updateLeaderboardPanel(),this.updateGlobalChampion(),this.hideNameInput(),this.pendingScore=null}hideNameInput(){this.nameInputModal.style.opacity="0",this.nameInputModal.querySelector(".name-input-content").style.transform="scale(0.8)",setTimeout((()=>{this.nameInputModal.style.display="none",document.getElementById("player-name").value="",document.getElementById("player-email").value="",document.getElementById("player-phone").value=""}),300)}clearLeaderboard(){confirm("Are you sure you want to clear all scores? This cannot be undone.")&&(this.leaderboard.clearScores(),this.updateLeaderboardPanel())}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}async updateGlobalChampion(){const e=document.getElementById("champion-name"),t=document.getElementById("champion-score");if(e&&t)try{const i=await this.leaderboard.getTopPlayer();if(i.success&&i.topPlayer&&i.topScore>0){e.textContent=i.topPlayer,t.textContent=this.leaderboard.formatScore(i.topScore);const s=document.getElementById("global-champion");s&&(s.style.animation="glow 2s infinite alternate")}else e.textContent="No champion yet",t.textContent="Be the first!"}catch(i){console.error("Error updating global champion:",i),e.textContent="Loading...",t.textContent="-"}}showValidationError(e,t){const i=document.getElementById(e);if(!i)return;const s=i.parentNode.querySelector(".validation-error");s&&s.remove();const n=document.createElement("div");n.className="validation-error",n.style.cssText="\n      color: #ff4444;\n      font-size: 0.75rem;\n      margin-bottom: 0.9375rem;\n      font-family: 'Courier New', monospace;\n      text-align: center;\n    ",n.textContent=t,i.style.borderColor="#ff4444",i.style.boxShadow="0 0 5px rgba(255, 68, 68, 0.5)",i.parentNode.insertBefore(n,i.nextSibling),i.focus()}clearValidationErrors(){document.querySelectorAll(".validation-error").forEach((e=>e.remove()));["player-name","player-email","player-phone"].forEach((e=>{const t=document.getElementById(e);t&&(t.style.borderColor="#2121ff",t.style.boxShadow="")}))}clearFieldValidationError(e){const t=document.getElementById(e);if(!t)return;const i=t.parentNode.querySelector(".validation-error");i&&i.remove(),t.style.borderColor="#2121ff",t.style.boxShadow=""}showNewRecordCelebration(e,t){const i=document.createElement("div");i.style.cssText="\n    position: fixed;\n    top: 50%;\n    left: 50%;\n    transform: translate(-50%, -50%);\n    background: linear-gradient(135deg, #ff6b6b, #ee5a24);\n    color: white;\n    padding: 30px;\n    border-radius: 20px;\n    text-align: center;\n    z-index: 10000;\n    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);\n    font-family: 'Courier New', monospace;\n    animation: celebrationPulse 1s infinite;\n  ",i.innerHTML=`\n    <div style="font-size: 24px; font-weight: bold; margin-bottom: 15px;">\n      üéâ NEW GLOBAL RECORD! üéâ\n    </div>\n    <div style="font-size: 18px; font-weight: bold;">\n      ${this.escapeHtml(e)} scored ${this.leaderboard.formatScore(t)}!\n    </div>\n    <div class="right-bottom">\n        <div class="terms-and-conditions">\n          <h3>Terms and Conditions:</h3>\n          <ul>\n            <li>\n              You must be a Compass member or have passed Caravan curation with\n              a valid payment link.\n            </li>\n            <li>Winners will be contacted via email.</li>\n            <li>\n              If a winner is not eligible, the next top scorer will take their\n              place.\n            </li>\n          </ul>\n        </div>\n\n        <div class="share-score">\n          <a href="" target="_blank" class="share-button">\n            Share my score! ‚Üí Forward to LinkedIn post\n          </a>\n        </div>\n      </div>\n  `,document.body.appendChild(i),setTimeout((()=>{i.parentNode&&i.parentNode.removeChild(i)}),5e3)}}class Ghost{constructor(e,t,i,s,n,a,o){this.scaledTileSize=e,this.mazeArray=t,this.pacman=i,this.name=s,this.level=n,this.characterUtil=a,this.blinky=o,this.animationTarget=document.getElementById(s),this.reset()}reset(e){e&&(delete this.defaultSpeed,delete this.cruiseElroy),this.setDefaultMode(),this.setMovementStats(this.pacman,this.name,this.level),this.setSpriteAnimationStats(),this.setStyleMeasurements(this.scaledTileSize,this.spriteFrames),this.setDefaultPosition(this.scaledTileSize,this.name),this.setSpriteSheet(this.name,this.direction,this.mode)}setDefaultMode(){this.allowCollision=!0,this.defaultMode="scatter",this.mode="scatter","blinky"!==this.name&&(this.idleMode="idle")}setMovementStats(e,t,i){const s=e.velocityPerMs,n=i/100;switch(this.slowSpeed=s*(.75+n),this.mediumSpeed=s*(.875+n),this.fastSpeed=s*(1+n),this.defaultSpeed||(this.defaultSpeed=this.slowSpeed),this.scaredSpeed=.5*s,this.transitionSpeed=.4*s,this.eyeSpeed=2*s,this.velocityPerMs=this.defaultSpeed,this.moving=!1,t){case"blinky":default:this.defaultDirection=this.characterUtil.directions.left;break;case"pinky":this.defaultDirection=this.characterUtil.directions.down;break;case"inky":case"clyde":this.defaultDirection=this.characterUtil.directions.up}this.direction=this.defaultDirection}setSpriteAnimationStats(){this.display=!0,this.loopAnimation=!0,this.animate=!0,this.msBetweenSprites=250,this.msSinceLastSprite=0,this.spriteFrames=2,this.backgroundOffsetPixels=0,this.animationTarget.style.backgroundPosition="0px 0px",this.animationTarget.classList.add("ghost-character")}setStyleMeasurements(e,t){this.measurement=2*e,this.animationTarget.style.height=`${this.measurement}px`,this.animationTarget.style.width=`${this.measurement}px`;const i=this.measurement*t;this.animationTarget.style.backgroundSize=`${i}px`}setDefaultPosition(e,t){switch(t){case"blinky":this.defaultPosition={top:10.5*e,left:13*e};break;case"pinky":this.defaultPosition={top:13.5*e,left:13*e};break;case"inky":this.defaultPosition={top:13.5*e,left:11*e};break;case"clyde":this.defaultPosition={top:13.5*e,left:15*e};break;default:this.defaultPosition={top:0,left:0}}this.position=Object.assign({},this.defaultPosition),this.oldPosition=Object.assign({},this.position),this.animationTarget.style.top=`${this.position.top}px`,this.animationTarget.style.left=`${this.position.left}px`}setSpriteSheet(e,t,i){let s="";this.defaultSpeed!==this.slowSpeed&&(s=this.defaultSpeed===this.mediumSpeed?"_annoyed":"_angry"),this.animationTarget.style.backgroundImage="scared"===i?`url(app/style/graphics/spriteSheets/characters/ghosts/scared_${this.scaredColor}.svg)`:"eyes"===i?`url(app/style/graphics/spriteSheets/characters/ghosts/eyes_${t}.svg)`:`url(app/style/graphics/spriteSheets/characters/ghosts/${e}/${e}_${t}${s}.svg)`}isInTunnel(e){return 14===e.y&&(e.x<6||e.x>21)}isInGhostHouse(e){return e.x>9&&e.x<18&&e.y>11&&e.y<17}getTile(e,t,i){let s=!1;return e[t]&&e[t][i]&&"X"!==e[t][i]&&(s={x:i,y:t}),s}determinePossibleMoves(e,t,i){const{x:s,y:n}=e,a={up:this.getTile(i,n-1,s),down:this.getTile(i,n+1,s),left:this.getTile(i,n,s-1),right:this.getTile(i,n,s+1)};return a[this.characterUtil.getOppositeDirection(t)]=!1,Object.keys(a).forEach((e=>{!1===a[e]&&delete a[e]})),a}calculateDistance(e,t){return Math.sqrt((e.x-t.x)**2+(e.y-t.y)**2)}getPositionInFrontOfPacman(e,t){const i=Object.assign({},e),s=this.pacman.direction,n="up"===s||"left"===s?-1*t:t;return i["up"===s||"down"===s?"y":"x"]+=n,i}determinePinkyTarget(e){return this.getPositionInFrontOfPacman(e,4)}determineInkyTarget(e){const t=this.characterUtil.determineGridPosition(this.blinky.position,this.scaledTileSize),i=this.getPositionInFrontOfPacman(e,2);return{x:i.x+(i.x-t.x),y:i.y+(i.y-t.y)}}determineClydeTarget(e,t){return this.calculateDistance(e,t)>8?t:{x:0,y:30}}getTarget(e,t,i,s){if("eyes"===s)return{x:13.5,y:10};if("scared"===s)return i;if("scatter"===s)switch(e){case"blinky":return this.cruiseElroy?i:{x:27,y:0};case"pinky":default:return{x:0,y:0};case"inky":return{x:27,y:30};case"clyde":return{x:0,y:30}}switch(e){case"blinky":default:return i;case"pinky":return this.determinePinkyTarget(i);case"inky":return this.determineInkyTarget(i);case"clyde":return this.determineClydeTarget(t,i)}}determineBestMove(e,t,i,s,n){let a,o="scared"===n?0:1/0;const r=this.getTarget(e,i,s,n);return Object.keys(t).forEach((e=>{const i=this.calculateDistance(t[e],r);("scared"===n?i>o:i<o)&&(o=i,a=e)})),a}determineDirection(e,t,i,s,n,a){let o=s;const r=this.determinePossibleMoves(t,s,n);return 1===Object.keys(r).length?[o]=Object.keys(r):Object.keys(r).length>1&&(o=this.determineBestMove(e,r,t,i,a)),o}handleIdleMovement(e,t,i){const s=Object.assign({},this.position);return t.y<=13.5?this.direction=this.characterUtil.directions.down:t.y>=14.5&&(this.direction=this.characterUtil.directions.up),"leaving"===this.idleMode&&(13.5===t.x&&t.y>10.8&&t.y<11?(this.idleMode=void 0,s.top=10.5*this.scaledTileSize,this.direction=this.characterUtil.directions.left,window.dispatchEvent(new Event("releaseGhost"))):t.x>13.4&&t.x<13.6?(s.left=13*this.scaledTileSize,this.direction=this.characterUtil.directions.up):t.y>13.9&&t.y<14.1&&(s.top=13.5*this.scaledTileSize,this.direction=t.x<13.5?this.characterUtil.directions.right:this.characterUtil.directions.left)),s[this.characterUtil.getPropertyToChange(this.direction)]+=this.characterUtil.getVelocity(this.direction,i)*e,s}endIdleMode(){this.idleMode="leaving"}handleSnappedMovement(e,t,i,s){const n=Object.assign({},this.position);return this.direction=this.determineDirection(this.name,t,s,this.direction,this.mazeArray,this.mode),n[this.characterUtil.getPropertyToChange(this.direction)]+=this.characterUtil.getVelocity(this.direction,i)*e,n}enteringGhostHouse(e,t){return"eyes"===e&&11===t.y&&t.x>13.4&&t.x<13.6}enteredGhostHouse(e,t){return"eyes"===e&&13.5===t.x&&t.y>13.8&&t.y<14.2}leavingGhostHouse(e,t){return"eyes"!==e&&13.5===t.x&&t.y>10.8&&t.y<11}handleGhostHouse(e){const t=Object.assign({},e);return this.enteringGhostHouse(this.mode,e)&&(this.direction=this.characterUtil.directions.down,t.x=13.5,this.position=this.characterUtil.snapToGrid(t,this.direction,this.scaledTileSize)),this.enteredGhostHouse(this.mode,e)&&(this.direction=this.characterUtil.directions.up,t.y=14,this.position=this.characterUtil.snapToGrid(t,this.direction,this.scaledTileSize),this.mode=this.defaultMode,window.dispatchEvent(new Event("restoreGhost"))),this.leavingGhostHouse(this.mode,e)&&(t.y=11,this.position=this.characterUtil.snapToGrid(t,this.direction,this.scaledTileSize),this.direction=this.characterUtil.directions.left),t}handleUnsnappedMovement(e,t,i){const s=this.handleGhostHouse(t),n=this.characterUtil.determineNewPositions(this.position,this.direction,i,e,this.scaledTileSize);return this.characterUtil.changingGridPosition(s,n.newGridPosition)?this.characterUtil.snapToGrid(s,this.direction,this.scaledTileSize):n.newPosition}handleMovement(e){let t;const i=this.characterUtil.determineGridPosition(this.position,this.scaledTileSize),s=this.characterUtil.determineGridPosition(this.pacman.position,this.scaledTileSize),n=this.determineVelocity(i,this.mode);return t=this.idleMode?this.handleIdleMovement(e,i,n):JSON.stringify(this.position)===JSON.stringify(this.characterUtil.snapToGrid(i,this.direction,this.scaledTileSize))?this.handleSnappedMovement(e,i,n,s):this.handleUnsnappedMovement(e,i,n),t=this.characterUtil.handleWarp(t,this.scaledTileSize,this.mazeArray),this.checkCollision(i,s),t}changeMode(e){this.defaultMode=e;const t=this.characterUtil.determineGridPosition(this.position,this.scaledTileSize);"chase"!==this.mode&&"scatter"!==this.mode||this.cruiseElroy||(this.mode=e,this.isInGhostHouse(t)||(this.direction=this.characterUtil.getOppositeDirection(this.direction)))}toggleScaredColor(){this.scaredColor="blue"===this.scaredColor?"white":"blue",this.setSpriteSheet(this.name,this.direction,this.mode)}becomeScared(){const e=this.characterUtil.determineGridPosition(this.position,this.scaledTileSize);"eyes"!==this.mode&&(this.isInGhostHouse(e)||"scared"===this.mode||(this.direction=this.characterUtil.getOppositeDirection(this.direction)),this.mode="scared",this.scaredColor="blue",this.setSpriteSheet(this.name,this.direction,this.mode))}endScared(){this.mode=this.defaultMode,this.setSpriteSheet(this.name,this.direction,this.mode)}speedUp(){this.cruiseElroy=!0,this.defaultSpeed===this.slowSpeed?this.defaultSpeed=this.mediumSpeed:this.defaultSpeed===this.mediumSpeed&&(this.defaultSpeed=this.fastSpeed)}resetDefaultSpeed(){this.defaultSpeed=this.slowSpeed,this.cruiseElroy=!1,this.setSpriteSheet(this.name,this.direction,this.mode)}pause(e){this.paused=e}checkCollision(e,t){this.calculateDistance(e,t)<1&&"eyes"!==this.mode&&this.allowCollision&&("scared"===this.mode?(window.dispatchEvent(new CustomEvent("eatGhost",{detail:{ghost:this}})),this.mode="eyes"):window.dispatchEvent(new Event("deathSequence")))}determineVelocity(e,t){return"eyes"===t?this.eyeSpeed:this.paused?0:this.isInTunnel(e)||this.isInGhostHouse(e)?this.transitionSpeed:"scared"===t?this.scaredSpeed:this.defaultSpeed}draw(e){const t=this.characterUtil.calculateNewDrawValue(e,"top",this.oldPosition,this.position),i=this.characterUtil.calculateNewDrawValue(e,"left",this.oldPosition,this.position);this.animationTarget.style.top=`${t}px`,this.animationTarget.style.left=`${i}px`;this.display&&"visible"===this.characterUtil.checkForStutter(this.position,this.oldPosition)?(this.animationTarget.classList.remove("character-hidden"),this.animationTarget.classList.add("character-visible")):(this.animationTarget.classList.remove("character-visible"),this.animationTarget.classList.add("character-hidden"));const s=this.characterUtil.advanceSpriteSheet(this);this.msSinceLastSprite=s.msSinceLastSprite,this.animationTarget=s.animationTarget,this.backgroundOffsetPixels=s.backgroundOffsetPixels}update(e){this.oldPosition=Object.assign({},this.position),this.moving&&(this.position=this.handleMovement(e),this.setSpriteSheet(this.name,this.direction,this.mode),this.msSinceLastSprite+=e)}}class Pacman{constructor(e,t,i){this.scaledTileSize=e,this.mazeArray=t,this.characterUtil=i,this.animationTarget=document.getElementById("pacman"),this.pacmanArrow=document.getElementById("pacman-arrow"),this.reset()}reset(){this.setMovementStats(this.scaledTileSize),this.setSpriteAnimationStats(),this.setStyleMeasurements(this.scaledTileSize,this.spriteFrames),this.setDefaultPosition(this.scaledTileSize),this.setSpriteSheet(this.direction),this.pacmanArrow.style.backgroundImage=`url(app/style/graphics/spriteSheets/characters/pacman/arrow_${this.direction}.svg)`}setMovementStats(e){this.velocityPerMs=this.calculateVelocityPerMs(e),this.desiredDirection=this.characterUtil.directions.left,this.direction=this.characterUtil.directions.left,this.moving=!1}setSpriteAnimationStats(){this.specialAnimation=!1,this.display=!0,this.animate=!0,this.loopAnimation=!0,this.msBetweenSprites=50,this.msSinceLastSprite=0,this.spriteFrames=4,this.backgroundOffsetPixels=0,this.animationTarget.classList.add("pacman-character"),this.pacmanArrow.classList.add("pacman-arrow")}setStyleMeasurements(e,t){this.measurement=2*e,this.animationTarget.style.height=`${this.measurement}px`,this.animationTarget.style.width=`${this.measurement}px`,this.animationTarget.style.backgroundSize=this.measurement*t+"px",this.pacmanArrow.style.height=2*this.measurement+"px",this.pacmanArrow.style.width=2*this.measurement+"px",this.pacmanArrow.style.backgroundSize=2*this.measurement+"px"}setDefaultPosition(e){this.defaultPosition={top:22.5*e,left:13*e},this.position=Object.assign({},this.defaultPosition),this.oldPosition=Object.assign({},this.position),this.animationTarget.style.top=`${this.position.top}px`,this.animationTarget.style.left=`${this.position.left}px`}calculateVelocityPerMs(e){return 11*e/1e3}setSpriteSheet(e){this.animationTarget.style.backgroundImage=`url(app/style/graphics/spriteSheets/characters/pacman/pacman_${e}.svg)`}prepDeathAnimation(){this.loopAnimation=!1,this.msBetweenSprites=125,this.spriteFrames=12,this.specialAnimation=!0,this.backgroundOffsetPixels=0;const e=this.measurement*this.spriteFrames;this.animationTarget.style.backgroundSize=`${e}px`,this.animationTarget.style.backgroundImage="url(app/style/graphics/spriteSheets/characters/pacman/pacman_death.svg)",this.animationTarget.style.backgroundPosition="0px 0px",this.pacmanArrow.style.backgroundImage=""}changeDirection(e,t){this.desiredDirection=e,this.pacmanArrow.style.backgroundImage=`url(app/style/graphics/spriteSheets/characters/pacman/arrow_${this.desiredDirection}.svg)`,t&&(this.moving=!0)}updatePacmanArrowPosition(e,t){this.pacmanArrow.style.top=e.top-t+"px",this.pacmanArrow.style.left=e.left-t+"px"}handleSnappedMovement(e){const t=this.characterUtil.determineNewPositions(this.position,this.desiredDirection,this.velocityPerMs,e,this.scaledTileSize),i=this.characterUtil.determineNewPositions(this.position,this.direction,this.velocityPerMs,e,this.scaledTileSize);return this.characterUtil.checkForWallCollision(t.newGridPosition,this.mazeArray,this.desiredDirection)?this.characterUtil.checkForWallCollision(i.newGridPosition,this.mazeArray,this.direction)?(this.moving=!1,this.position):i.newPosition:(this.direction=this.desiredDirection,this.setSpriteSheet(this.direction),t.newPosition)}handleUnsnappedMovement(e,t){const i=this.characterUtil.determineNewPositions(this.position,this.desiredDirection,this.velocityPerMs,t,this.scaledTileSize),s=this.characterUtil.determineNewPositions(this.position,this.direction,this.velocityPerMs,t,this.scaledTileSize);return this.characterUtil.turningAround(this.direction,this.desiredDirection)?(this.direction=this.desiredDirection,this.setSpriteSheet(this.direction),i.newPosition):this.characterUtil.changingGridPosition(e,s.newGridPosition)?this.characterUtil.snapToGrid(e,this.direction,this.scaledTileSize):s.newPosition}draw(e){const t=this.characterUtil.calculateNewDrawValue(e,"top",this.oldPosition,this.position),i=this.characterUtil.calculateNewDrawValue(e,"left",this.oldPosition,this.position);this.animationTarget.style.top=`${t}px`,this.animationTarget.style.left=`${i}px`;this.display&&"visible"===this.characterUtil.checkForStutter(this.position,this.oldPosition)?(this.animationTarget.classList.remove("character-hidden"),this.animationTarget.classList.add("character-visible"),this.pacmanArrow.classList.remove("character-hidden"),this.pacmanArrow.classList.add("character-visible")):(this.animationTarget.classList.remove("character-visible"),this.animationTarget.classList.add("character-hidden"),this.pacmanArrow.classList.remove("character-visible"),this.pacmanArrow.classList.add("character-hidden")),this.updatePacmanArrowPosition(this.position,this.scaledTileSize);const s=this.characterUtil.advanceSpriteSheet(this);this.msSinceLastSprite=s.msSinceLastSprite,this.animationTarget=s.animationTarget,this.backgroundOffsetPixels=s.backgroundOffsetPixels}update(e){if(this.oldPosition=Object.assign({},this.position),this.moving){const t=this.characterUtil.determineGridPosition(this.position,this.scaledTileSize);JSON.stringify(this.position)===JSON.stringify(this.characterUtil.snapToGrid(t,this.direction,this.scaledTileSize))?this.position=this.handleSnappedMovement(e):this.position=this.handleUnsnappedMovement(t,e),this.position=this.characterUtil.handleWarp(this.position,this.scaledTileSize,this.mazeArray)}(this.moving||this.specialAnimation)&&(this.msSinceLastSprite+=e)}}class GameCoordinator{constructor(){this.gameUi=document.getElementById("game-ui"),this.rowTop=document.getElementById("row-top"),this.mazeDiv=document.getElementById("maze"),this.mazeImg=document.getElementById("maze-img"),this.mazeCover=document.getElementById("maze-cover"),this.pointsDisplay=document.getElementById("points-display"),this.highScoreDisplay=document.getElementById("high-score-display"),this.extraLivesDisplay=document.getElementById("extra-lives"),this.fruitDisplay=document.getElementById("fruit-display"),this.mainMenu=document.getElementById("main-menu-container"),this.gameStartButton=document.getElementById("game-start"),this.pauseButton=document.getElementById("pause-button"),this.soundButton=document.getElementById("sound-button"),this.leftCover=document.getElementById("left-cover"),this.rightCover=document.getElementById("right-cover"),this.pausedText=document.getElementById("paused-text"),this.bottomRow=document.getElementById("bottom-row"),this.leaderboard=new Leaderboard,this.leaderboardUI=new PageRightLeaderboardUI(this.leaderboard,this),this.mazeArray=[["XXXXXXXXXXXXXXXXXXXXXXXXXXXX"],["XooooooooooooXXooooooooooooX"],["XoXXXXoXXXXXoXXoXXXXXoXXXXoX"],["XOXXXXoXXXXXoXXoXXXXXoXXXXOX"],["XoXXXXoXXXXXoXXoXXXXXoXXXXoX"],["XooooooooooooooooooooooooooX"],["XoXXXXoXXoXXXXXXXXoXXoXXXXoX"],["XoXXXXoXXoXXXXXXXXoXXoXXXXoX"],["XooooooXXooooXXooooXXooooooX"],["XXXXXXoXXXXX XX XXXXXoXXXXXX"],["XXXXXXoXXXXX XX XXXXXoXXXXXX"],["XXXXXXoXX          XXoXXXXXX"],["XXXXXXoXX XXXXXXXX XXoXXXXXX"],["XXXXXXoXX X      X XXoXXXXXX"],["      o   X      X   o      "],["XXXXXXoXX X      X XXoXXXXXX"],["XXXXXXoXX XXXXXXXX XXoXXXXXX"],["XXXXXXoXX          XXoXXXXXX"],["XXXXXXoXX XXXXXXXX XXoXXXXXX"],["XXXXXXoXX XXXXXXXX XXoXXXXXX"],["XooooooooooooXXooooooooooooX"],["XoXXXXoXXXXXoXXoXXXXXoXXXXoX"],["XoXXXXoXXXXXoXXoXXXXXoXXXXoX"],["XOooXXooooooo  oooooooXXooOX"],["XXXoXXoXXoXXXXXXXXoXXoXXoXXX"],["XXXoXXoXXoXXXXXXXXoXXoXXoXXX"],["XooooooXXooooXXooooXXooooooX"],["XoXXXXXXXXXXoXXoXXXXXXXXXXoX"],["XoXXXXXXXXXXoXXoXXXXXXXXXXoX"],["XooooooooooooooooooooooooooX"],["XXXXXXXXXXXXXXXXXXXXXXXXXXXX"]],this.maxFps=120,this.tileSize=8,this.scale=this.determineScale(1),this.scaledTileSize=this.tileSize*this.scale,this.firstGame=!0,this.movementKeys={87:"up",83:"down",65:"left",68:"right",38:"up",40:"down",37:"left",39:"right"},this.touchStartX=0,this.touchStartY=0,this.touchEndX=0,this.touchEndY=0,this.fruitPoints={1:100,2:300,3:500,4:700,5:1e3,6:2e3,7:3e3,8:5e3},this.mazeArray.forEach(((e,t)=>{this.mazeArray[t]=e[0].split("")})),this.gameStartButton.addEventListener("click",this.startButtonClick.bind(this)),this.pauseButton.addEventListener("click",this.handlePauseKey.bind(this)),this.soundButton.addEventListener("click",this.soundButtonClick.bind(this));const e=document.getElementsByTagName("head")[0],t=document.createElement("link");t.rel="stylesheet",t.href="build/app.css",t.onload=this.preloadAssets.bind(this),e.appendChild(t)}determineScale(e){const t=Math.min(document.documentElement.clientHeight,window.innerHeight||0),i=Math.min(document.documentElement.clientWidth,window.innerWidth||0),s=this.tileSize*e,n=this.mazeArray.length+5,a=this.mazeArray[0][0].split("").length;return s*n<t&&s*a<i?this.determineScale(e+1):e-1}startButtonClick(){this.leftCover.classList.add("cover-left-hidden"),this.rightCover.classList.add("cover-right-hidden"),this.mainMenu.classList.add("loading-opacity-fade"),this.gameStartButton.disabled=!0,setTimeout((()=>{this.mainMenu.classList.add("main-menu-hidden"),this.mainMenu.classList.remove("main-menu-visible")}),1e3),this.reset(),this.firstGame&&(this.firstGame=!1,this.init()),this.startGameplay(!0)}soundButtonClick(){const e=1===this.soundManager.masterVolume?0:1;this.soundManager.setMasterVolume(e),localStorage.setItem("volumePreference",e),this.setSoundButtonIcon(e)}setSoundButtonIcon(e){this.soundButton.innerHTML=0===e?"volume_off":"volume_up"}displayErrorMessage(){const e=document.getElementById("loading-container"),t=document.getElementById("error-message");e.classList.add("loading-opacity-fade"),setTimeout((()=>{e.remove(),t.classList.add("error-message-visible")}),1500)}preloadAssets(){return new Promise((e=>{const t=document.getElementById("loading-container"),i=document.getElementById("loading-pacman"),s=document.getElementById("loading-dot-mask"),n="app/style/graphics/spriteSheets/",a=[`${n}characters/pacman/arrow_down.svg`,`${n}characters/pacman/arrow_left.svg`,`${n}characters/pacman/arrow_right.svg`,`${n}characters/pacman/arrow_up.svg`,`${n}characters/pacman/pacman_death.svg`,`${n}characters/pacman/pacman_error.svg`,`${n}characters/pacman/pacman_down.svg`,`${n}characters/pacman/pacman_left.svg`,`${n}characters/pacman/pacman_right.svg`,`${n}characters/pacman/pacman_up.svg`,`${n}characters/ghosts/blinky/blinky_down_angry.svg`,`${n}characters/ghosts/blinky/blinky_down_annoyed.svg`,`${n}characters/ghosts/blinky/blinky_down.svg`,`${n}characters/ghosts/blinky/blinky_left_angry.svg`,`${n}characters/ghosts/blinky/blinky_left_annoyed.svg`,`${n}characters/ghosts/blinky/blinky_left.svg`,`${n}characters/ghosts/blinky/blinky_right_angry.svg`,`${n}characters/ghosts/blinky/blinky_right_annoyed.svg`,`${n}characters/ghosts/blinky/blinky_right.svg`,`${n}characters/ghosts/blinky/blinky_up_angry.svg`,`${n}characters/ghosts/blinky/blinky_up_annoyed.svg`,`${n}characters/ghosts/blinky/blinky_up.svg`,`${n}characters/ghosts/clyde/clyde_down.svg`,`${n}characters/ghosts/clyde/clyde_left.svg`,`${n}characters/ghosts/clyde/clyde_right.svg`,`${n}characters/ghosts/clyde/clyde_up.svg`,`${n}characters/ghosts/inky/inky_down.svg`,`${n}characters/ghosts/inky/inky_left.svg`,`${n}characters/ghosts/inky/inky_right.svg`,`${n}characters/ghosts/inky/inky_up.svg`,`${n}characters/ghosts/pinky/pinky_down.svg`,`${n}characters/ghosts/pinky/pinky_left.svg`,`${n}characters/ghosts/pinky/pinky_right.svg`,`${n}characters/ghosts/pinky/pinky_up.svg`,`${n}characters/ghosts/eyes_down.svg`,`${n}characters/ghosts/eyes_left.svg`,`${n}characters/ghosts/eyes_right.svg`,`${n}characters/ghosts/eyes_up.svg`,`${n}characters/ghosts/scared_blue.svg`,`${n}characters/ghosts/scared_white.svg`,`${n}pickups/pacdot.svg`,`${n}pickups/powerPellet.svg`,`${n}pickups/apple.svg`,`${n}pickups/bell.svg`,`${n}pickups/cherry.svg`,`${n}pickups/galaxian.svg`,`${n}pickups/key.svg`,`${n}pickups/melon.svg`,`${n}pickups/orange.svg`,`${n}pickups/strawberry.svg`,`${n}text/ready.svg`,`${n}text/100.svg`,`${n}text/200.svg`,`${n}text/300.svg`,`${n}text/400.svg`,`${n}text/500.svg`,`${n}text/700.svg`,`${n}text/800.svg`,`${n}text/1000.svg`,`${n}text/1600.svg`,`${n}text/2000.svg`,`${n}text/3000.svg`,`${n}text/5000.svg`,`${n}maze/maze_blue.svg`,"app/style/graphics/extra_life.svg"],o="app/style/audio/",r=[`${o}game_start.mp3`,`${o}pause.mp3`,`${o}pause_beat.mp3`,`${o}siren_1.mp3`,`${o}siren_2.mp3`,`${o}siren_3.mp3`,`${o}power_up.mp3`,`${o}extra_life.mp3`,`${o}eyes.mp3`,`${o}eat_ghost.mp3`,`${o}death.mp3`,`${o}fruit.mp3`,`${o}dot_1.mp3`,`${o}dot_2.mp3`],h=a.length+r.length;this.remainingSources=h,i.style.left="0",s.style.width="0",Promise.all([this.createElements(a,"img",h,this),this.createElements(r,"audio",h,this)]).then((()=>{t.classList.add("loading-opacity-fade"),e(),setTimeout((()=>{t.remove(),this.mainMenu.classList.add("main-menu-visible"),this.mainMenu.classList.remove("main-menu-hidden")}),1500)})).catch(this.displayErrorMessage)}))}createElements(e,t,i,s){const n=document.getElementById("loading-container"),a=document.getElementById("preload-div"),o=document.getElementById("loading-pacman"),r=n.scrollWidth-o.scrollWidth,h=document.getElementById("loading-dot-mask"),l=s;return new Promise(((s,n)=>{let c=0;e.forEach((d=>{const m="img"===t?new Image:new Audio;a.appendChild(m);const p=()=>{l.remainingSources-=1,c+=1;const t=1-l.remainingSources/i;o.style.left=t*r+"px",h.style.width=o.style.left,c===e.length&&s()};"img"===t?(m.onload=p,m.onerror=n):(m.addEventListener("canplaythrough",p),m.onerror=n),m.src=d,"audio"===t&&m.load()}))}))}reset(){this.activeTimers=[],this.points=0,this.level=1,this.lives=2,this.extraLifeGiven=!1,this.remainingDots=0,this.allowKeyPresses=!0,this.allowPacmanMovement=!1,this.allowPause=!1,this.cutscene=!0,this.highScore=this.leaderboard.getHighScore(),this.firstGame&&(setInterval((()=>{this.collisionDetectionLoop()}),500),this.pacman=new Pacman(this.scaledTileSize,this.mazeArray,new CharacterUtil(this.scaledTileSize)),this.blinky=new Ghost(this.scaledTileSize,this.mazeArray,this.pacman,"blinky",this.level,new CharacterUtil(this.scaledTileSize)),this.pinky=new Ghost(this.scaledTileSize,this.mazeArray,this.pacman,"pinky",this.level,new CharacterUtil(this.scaledTileSize)),this.inky=new Ghost(this.scaledTileSize,this.mazeArray,this.pacman,"inky",this.level,new CharacterUtil(this.scaledTileSize),this.blinky),this.clyde=new Ghost(this.scaledTileSize,this.mazeArray,this.pacman,"clyde",this.level,new CharacterUtil(this.scaledTileSize)),this.fruit=new Pickup("fruit",this.scaledTileSize,13.5,17,this.pacman,this.mazeDiv,100)),this.entityList=[this.pacman,this.blinky,this.pinky,this.inky,this.clyde,this.fruit],this.ghosts=[this.blinky,this.pinky,this.inky,this.clyde],this.scaredGhosts=[],this.eyeGhosts=0,this.firstGame?(this.drawMaze(this.mazeArray,this.entityList),this.soundManager=new SoundManager,this.setUiDimensions()):(this.pacman.reset(),this.ghosts.forEach((e=>{e.reset(!0)})),this.pickups.forEach((e=>{"fruit"!==e.type&&(this.remainingDots+=1,e.reset(),this.entityList.push(e))}))),this.pointsDisplay.innerHTML="00",this.highScoreDisplay.innerHTML=this.highScore||"00",this.clearDisplay(this.fruitDisplay);const e=parseInt(localStorage.getItem("volumePreference")||1,10);this.setSoundButtonIcon(e),this.soundManager.setMasterVolume(e)}init(){this.registerEventListeners(),this.registerTouchListeners(),this.gameEngine=new GameEngine(this.maxFps,this.entityList),this.gameEngine.start()}drawMaze(e,t){this.pickups=[this.fruit],this.mazeDiv.style.height=31*this.scaledTileSize+"px",this.mazeDiv.style.width=28*this.scaledTileSize+"px",this.gameUi.style.width=28*this.scaledTileSize+"px",this.bottomRow.style.minHeight=2*this.scaledTileSize+"px",this.dotContainer=document.getElementById("dot-container"),e.forEach(((e,i)=>{e.forEach(((e,s)=>{if("o"===e||"O"===e){const n="o"===e?10:50,a=new Pickup("o"===e?"pacdot":"powerPellet",this.scaledTileSize,s,i,this.pacman,this.dotContainer,n);t.push(a),this.pickups.push(a),this.remainingDots+=1}}))}))}setUiDimensions(){this.gameUi.style.fontSize=`${this.scaledTileSize}px`,this.rowTop.style.marginBottom=`${this.scaledTileSize}px`}collisionDetectionLoop(){if(this.pacman.position){const e=750*this.pacman.velocityPerMs,t={x:this.pacman.position.left+this.scaledTileSize,y:this.pacman.position.top+this.scaledTileSize},i=!1;this.pickups.forEach((s=>{s.checkPacmanProximity(e,t,i)}))}}startGameplay(e){e&&this.soundManager.play("game_start"),this.scaredGhosts=[],this.eyeGhosts=0,this.allowPacmanMovement=!1;const t=11*this.scaledTileSize,i=16.5*this.scaledTileSize,s=e?4500:2e3,n=6*this.scaledTileSize,a=2*this.scaledTileSize;this.displayText({left:t,top:i},"ready",s,n,a),this.updateExtraLivesDisplay(),new Timer((()=>{this.allowPause=!0,this.cutscene=!1,this.soundManager.setCutscene(this.cutscene),this.soundManager.setAmbience(this.determineSiren(this.remainingDots)),this.allowPacmanMovement=!0,this.pacman.moving=!0,this.ghosts.forEach((e=>{e.moving=!0})),this.ghostCycle("scatter"),this.idleGhosts=[this.pinky,this.inky,this.clyde],this.releaseGhost()}),s)}clearDisplay(e){for(;e.firstChild;)e.removeChild(e.firstChild)}updateExtraLivesDisplay(){this.clearDisplay(this.extraLivesDisplay);for(let e=0;e<this.lives;e+=1){const e=document.createElement("img");e.setAttribute("src","app/style/graphics/extra_life.svg"),e.style.height=2*this.scaledTileSize+"px",this.extraLivesDisplay.appendChild(e)}}updateFruitDisplay(e){const t=e.slice(e.indexOf("(")+1,e.indexOf(")"));7===this.fruitDisplay.children.length&&this.fruitDisplay.removeChild(this.fruitDisplay.firstChild);const i=document.createElement("img");i.setAttribute("src",t),i.style.height=2*this.scaledTileSize+"px",this.fruitDisplay.appendChild(i)}ghostCycle(e){const t="scatter"===e?7e3:2e4,i="scatter"===e?"chase":"scatter";this.ghostCycleTimer=new Timer((()=>{this.ghosts.forEach((e=>{e.changeMode(i)})),this.ghostCycle(i)}),t)}releaseGhost(){if(this.idleGhosts.length>0){const e=Math.max(1e3*(8-4*(this.level-1)),0);this.endIdleTimer=new Timer((()=>{this.idleGhosts[0].endIdleMode(),this.idleGhosts.shift()}),e)}}registerEventListeners(){window.addEventListener("keydown",this.handleKeyDown.bind(this)),window.addEventListener("swipe",this.handleSwipe.bind(this)),window.addEventListener("awardPoints",this.awardPoints.bind(this)),window.addEventListener("deathSequence",this.deathSequence.bind(this)),window.addEventListener("dotEaten",this.dotEaten.bind(this)),window.addEventListener("powerUp",this.powerUp.bind(this)),window.addEventListener("eatGhost",this.eatGhost.bind(this)),window.addEventListener("restoreGhost",this.restoreGhost.bind(this)),window.addEventListener("addTimer",this.addTimer.bind(this)),window.addEventListener("removeTimer",this.removeTimer.bind(this)),window.addEventListener("releaseGhost",this.releaseGhost.bind(this))}registerTouchListeners(){document.addEventListener("touchstart",this.handleTouchStart.bind(this)),document.addEventListener("touchend",this.handleTouchEnd.bind(this))}handleTouchStart(e){this.touchStartX=e.touches[0].clientX,this.touchStartY=e.touches[0].clientY}handleTouchEnd(e){this.touchEndX=e.changedTouches[0].clientX,this.touchEndY=e.changedTouches[0].clientY;const t=this.touchEndX-this.touchStartX,i=this.touchEndY-this.touchStartY;let s;s=Math.abs(t)>Math.abs(i)?t>0?"right":"left":i>0?"down":"up",window.dispatchEvent(new CustomEvent("swipe",{detail:{direction:s}}))}changeDirection(e){this.allowKeyPresses&&this.gameEngine.running&&this.pacman.changeDirection(e,this.allowPacmanMovement)}handleKeyDown(e){27===e.keyCode?this.handlePauseKey():81===e.keyCode?this.soundButtonClick():this.movementKeys[e.keyCode]&&this.changeDirection(this.movementKeys[e.keyCode])}handleSwipe(e){const{direction:t}=e.detail;this.changeDirection(t)}handlePauseKey(){this.allowPause&&(this.allowPause=!1,setTimeout((()=>{this.cutscene||(this.allowPause=!0)}),500),this.gameEngine.changePausedState(this.gameEngine.running),this.soundManager.play("pause"),this.gameEngine.started?(this.soundManager.resumeAmbience(),this.gameUi.classList.add("game-ui-clear"),this.gameUi.classList.remove("game-ui-blur"),this.pausedText.classList.add("game-element-hidden"),this.pausedText.classList.remove("game-element-visible"),this.pauseButton.innerHTML="pause",this.activeTimers.forEach((e=>{e.resume()}))):(this.soundManager.stopAmbience(),this.soundManager.setAmbience("pause_beat",!0),this.gameUi.classList.add("game-ui-blur"),this.gameUi.classList.remove("game-ui-clear"),this.pausedText.classList.add("game-element-visible"),this.pausedText.classList.remove("game-element-hidden"),this.pauseButton.innerHTML="play_arrow",this.activeTimers.forEach((e=>{e.pause()}))))}awardPoints(e){this.points+=e.detail.points,this.pointsDisplay.innerText=this.points;const t=this.leaderboard.getHighScore();if(this.points>(this.highScore||0)&&(this.highScore=this.points,this.highScoreDisplay.innerText=this.points),t>(this.highScore||0)&&(this.highScoreDisplay.innerText=t),this.points>=1e4&&!this.extraLifeGiven&&(this.extraLifeGiven=!0,this.soundManager.play("extra_life"),this.lives+=1,this.updateExtraLivesDisplay()),"fruit"===e.detail.type){const t=e.detail.points>=1e3?11.5*this.scaledTileSize:13*this.scaledTileSize;this.displayText({left:t,top:16.5*this.scaledTileSize},e.detail.points,2e3,this.fruitDisplay)}}deathSequence(){this.allowPause=!1,this.cutscene=!0,this.soundManager.setCutscene(this.cutscene),this.soundManager.stopAmbience(),this.removeTimer({detail:{timer:this.fruitTimer}}),this.removeTimer({detail:{timer:this.ghostCycleTimer}}),this.removeTimer({detail:{timer:this.endIdleTimer}}),this.removeTimer({detail:{timer:this.ghostFlashTimer}}),this.allowKeyPresses=!1,this.pacman.moving=!1,this.ghosts.forEach((e=>{e.moving=!1})),new Timer((()=>{this.ghosts.forEach((e=>{e.display=!1})),this.pacman.prepDeathAnimation(),this.soundManager.play("death"),this.lives>0?(this.lives-=1,new Timer((()=>{this.mazeCover.classList.add("game-element-visible"),this.mazeCover.classList.remove("game-element-hidden"),new Timer((()=>{this.allowKeyPresses=!0,this.mazeCover.classList.add("game-element-hidden"),this.mazeCover.classList.remove("game-element-visible"),this.pacman.reset(),this.ghosts.forEach((e=>{e.reset()})),this.fruit.hideFruit(),this.startGameplay()}),500)}),2250)):this.gameOver()}),750)}gameOver(){this.allowKeyPresses=!1,console.log("Game over, showing name input for score:",this.points),setTimeout((()=>{this.leaderboardUI&&this.leaderboardUI.showNameInput?this.leaderboardUI.showNameInput(this.points,this.level):(console.error("LeaderboardUI not properly initialized"),this.leaderboard.addScore("Anonymous",this.points,this.level))}),2e3);const e=this.leaderboard.getHighScore();e>(this.highScore||0)&&(this.highScore=e,this.highScoreDisplay.innerText=e),localStorage.setItem("highScore",this.leaderboard.getHighScore()),new Timer((()=>{this.displayText({left:9*this.scaledTileSize,top:16.5*this.scaledTileSize},"game_over",2500,this.mazeDiv),this.fruit.hideFruit(),new Timer((()=>{this.leftCover.classList.remove("cover-left-hidden"),this.leftCover.classList.add("cover-left-visible"),this.rightCover.classList.remove("cover-right-hidden"),this.rightCover.classList.add("cover-right-visible"),new Timer((()=>{this.mainMenu.classList.add("main-menu-visible"),this.mainMenu.classList.remove("main-menu-hidden"),this.gameStartButton.disabled=!1}),1e3)}),2500)}),2250)}showLeaderboard(){this.leaderboardUI.showLeaderboard()}getLeaderboardData(){return{scores:this.leaderboard.getTopScores(),statistics:this.leaderboard.getStatistics(),highScore:this.leaderboard.getHighScore()}}dotEaten(){this.remainingDots-=1,this.soundManager.playDotSound(),174!==this.remainingDots&&74!==this.remainingDots||this.createFruit(),40!==this.remainingDots&&20!==this.remainingDots||this.speedUpBlinky(),0===this.remainingDots&&this.advanceLevel()}createFruit(){this.removeTimer({detail:{timer:this.fruitTimer}}),this.fruit.showFruit(this.fruitPoints[this.level]||5e3),this.fruitTimer=new Timer((()=>{this.fruit.hideFruit()}),1e4)}speedUpBlinky(){this.blinky.speedUp(),0===this.scaredGhosts.length&&0===this.eyeGhosts&&this.soundManager.setAmbience(this.determineSiren(this.remainingDots))}determineSiren(e){let t;return t=e>40?1:e>20?2:3,`siren_${t}`}advanceLevel(){this.allowPause=!1,this.cutscene=!0,this.soundManager.setCutscene(this.cutscene),this.allowKeyPresses=!1,this.soundManager.stopAmbience(),this.entityList.forEach((e=>{e.moving=!1})),this.removeTimer({detail:{timer:this.fruitTimer}}),this.removeTimer({detail:{timer:this.ghostCycleTimer}}),this.removeTimer({detail:{timer:this.endIdleTimer}}),this.removeTimer({detail:{timer:this.ghostFlashTimer}});const e="app/style//graphics/spriteSheets/maze/";new Timer((()=>{this.ghosts.forEach((e=>{e.display=!1})),this.mazeImg.src=`${e}maze_white.svg`,new Timer((()=>{this.mazeImg.src=`${e}maze_blue.svg`,new Timer((()=>{this.mazeImg.src=`${e}maze_white.svg`,new Timer((()=>{this.mazeImg.src=`${e}maze_blue.svg`,new Timer((()=>{this.mazeImg.src=`${e}maze_white.svg`,new Timer((()=>{this.mazeImg.src=`${e}maze_blue.svg`,new Timer((()=>{this.mazeCover.classList.add("game-element-visible"),this.mazeCover.classList.remove("game-element-hidden"),new Timer((()=>{this.mazeCover.classList.add("game-element-hidden"),this.mazeCover.classList.remove("game-element-visible"),this.level+=1,this.allowKeyPresses=!0,this.entityList.forEach((e=>{const t=e;t.level&&(t.level=this.level),t.reset(),t instanceof Ghost&&t.resetDefaultSpeed(),t instanceof Pickup&&"fruit"!==t.type&&(this.remainingDots+=1)})),this.startGameplay()}),500)}),250)}),250)}),250)}),250)}),250)}),250)}),2e3)}flashGhosts(e,t){e===t?(this.scaredGhosts.forEach((e=>{e.endScared()})),this.scaredGhosts=[],0===this.eyeGhosts&&this.soundManager.setAmbience(this.determineSiren(this.remainingDots))):this.scaredGhosts.length>0&&(this.scaredGhosts.forEach((e=>{e.toggleScaredColor()})),this.ghostFlashTimer=new Timer((()=>{this.flashGhosts(e+1,t)}),250))}powerUp(){0!==this.remainingDots&&this.soundManager.setAmbience("power_up"),this.removeTimer({detail:{timer:this.ghostFlashTimer}}),this.ghostCombo=0,this.scaredGhosts=[],this.ghosts.forEach((e=>{"eyes"!==e.mode&&this.scaredGhosts.push(e)})),this.scaredGhosts.forEach((e=>{e.becomeScared()}));const e=Math.max(1e3*(7-this.level),0);this.ghostFlashTimer=new Timer((()=>{this.flashGhosts(0,9)}),e)}determineComboPoints(){return 100*2**this.ghostCombo}eatGhost(e){const{position:t,measurement:i}=e.detail.ghost;this.pauseTimer({detail:{timer:this.ghostFlashTimer}}),this.pauseTimer({detail:{timer:this.ghostCycleTimer}}),this.pauseTimer({detail:{timer:this.fruitTimer}}),this.soundManager.play("eat_ghost"),this.scaredGhosts=this.scaredGhosts.filter((t=>t.name!==e.detail.ghost.name)),this.eyeGhosts+=1,this.ghostCombo+=1;const s=this.determineComboPoints();window.dispatchEvent(new CustomEvent("awardPoints",{detail:{points:s}})),this.displayText(t,s,1e3,i),this.allowPacmanMovement=!1,this.pacman.display=!1,this.pacman.moving=!1,e.detail.ghost.display=!1,e.detail.ghost.moving=!1,this.ghosts.forEach((e=>{const t=e;t.animate=!1,t.pause(!0),t.allowCollision=!1})),new Timer((()=>{this.soundManager.setAmbience("eyes"),this.resumeTimer({detail:{timer:this.ghostFlashTimer}}),this.resumeTimer({detail:{timer:this.ghostCycleTimer}}),this.resumeTimer({detail:{timer:this.fruitTimer}}),this.allowPacmanMovement=!0,this.pacman.display=!0,this.pacman.moving=!0,e.detail.ghost.display=!0,e.detail.ghost.moving=!0,this.ghosts.forEach((e=>{const t=e;t.animate=!0,t.pause(!1),t.allowCollision=!0}))}),1e3)}restoreGhost(){if(this.eyeGhosts-=1,0===this.eyeGhosts){const e=this.scaredGhosts.length>0?"power_up":this.determineSiren(this.remainingDots);this.soundManager.setAmbience(e)}}displayText(e,t,i,s,n){const a=document.createElement("div");a.style.position="absolute",a.style.backgroundSize=`${s}px`,a.style.backgroundImage=`url(app/style/graphics/spriteSheets/text/${t}.svg`,a.style.width=`${s}px`,a.style.height=`${n||s}px`,a.style.top=`${e.top}px`,a.style.left=`${e.left}px`,a.style.zIndex=2,this.mazeDiv.appendChild(a),new Timer((()=>{this.mazeDiv.removeChild(a)}),i)}addTimer(e){this.activeTimers.push(e.detail.timer)}timerExists(e){return!!(e.detail.timer||{}).timerId}pauseTimer(e){this.timerExists(e)&&e.detail.timer.pause(!0)}resumeTimer(e){this.timerExists(e)&&e.detail.timer.resume(!0)}removeTimer(e){this.timerExists(e)&&(window.clearTimeout(e.detail.timer.timerId),this.activeTimers=this.activeTimers.filter((t=>t.timerId!==e.detail.timer.timerId)))}}class GameEngine{constructor(e,t){this.fpsDisplay=document.getElementById("fps-display"),this.elapsedMs=0,this.lastFrameTimeMs=0,this.entityList=t,this.maxFps=e,this.timestep=1e3/this.maxFps,this.fps=this.maxFps,this.framesThisSecond=0,this.lastFpsUpdate=0,this.frameId=0,this.running=!1,this.started=!1}changePausedState(e){e?this.stop():this.start()}updateFpsDisplay(e){e>this.lastFpsUpdate+1e3&&(this.fps=(this.framesThisSecond+this.fps)/2,this.lastFpsUpdate=e,this.framesThisSecond=0),this.framesThisSecond+=1,this.fpsDisplay.textContent=`${Math.round(this.fps)} FPS`}draw(e,t){t.forEach((t=>{"function"==typeof t.draw&&t.draw(e)}))}update(e,t){t.forEach((t=>{"function"==typeof t.update&&t.update(e)}))}panic(){this.elapsedMs=0}start(){this.started||(this.started=!0,this.frameId=requestAnimationFrame((e=>{this.draw(1,[]),this.running=!0,this.lastFrameTimeMs=e,this.lastFpsUpdate=e,this.framesThisSecond=0,this.frameId=requestAnimationFrame((e=>{this.mainLoop(e)}))})))}stop(){this.running=!1,this.started=!1,cancelAnimationFrame(this.frameId)}processFrames(){let e=0;for(;this.elapsedMs>=this.timestep;)if(this.update(this.timestep,this.entityList),this.elapsedMs-=this.timestep,e+=1,e>=this.maxFps){this.panic();break}}engineCycle(e){e<this.lastFrameTimeMs+1e3/this.maxFps||(this.elapsedMs+=e-this.lastFrameTimeMs,this.lastFrameTimeMs=e,this.updateFpsDisplay(e),this.processFrames(),this.draw(this.elapsedMs/this.timestep,this.entityList)),this.frameId=requestAnimationFrame((e=>{this.mainLoop(e)}))}mainLoop(e){this.engineCycle(e)}}class Pickup{constructor(e,t,i,s,n,a,o){this.type=e,this.pacman=n,this.mazeDiv=a,this.points=o,this.nearPacman=!1,this.fruitImages={100:"cherry",300:"strawberry",500:"orange",700:"apple",1e3:"melon",2e3:"galaxian",3e3:"bell",5e3:"key"},this.setStyleMeasurements(e,t,i,s,o)}reset(){this.animationTarget.className="fruit"===this.type?"pickup-base pickup-hidden":"pickup-base pickup-visible"}setStyleMeasurements(e,t,i,s,n){"pacdot"===e?(this.size=.25*t,this.x=i*t+t/8*3,this.y=s*t+t/8*3):"powerPellet"===e?(this.size=t,this.x=i*t,this.y=s*t):(this.size=2*t,this.x=i*t-.5*t,this.y=s*t-.5*t),this.center={x:i*t,y:s*t},this.animationTarget=document.createElement("div"),this.animationTarget.className="pickup-base",this.animationTarget.style.backgroundSize=`${this.size}px`,this.animationTarget.style.backgroundImage=this.determineImage(e,n),this.animationTarget.style.height=`${this.size}px`,this.animationTarget.style.width=`${this.size}px`,this.animationTarget.style.top=`${this.y}px`,this.animationTarget.style.left=`${this.x}px`,this.mazeDiv.appendChild(this.animationTarget),"powerPellet"===e&&this.animationTarget.classList.add("power-pellet"),this.reset()}determineImage(e,t){let i="";return i="fruit"===e?this.fruitImages[t]||"cherry":e,`url(app/style/graphics/spriteSheets/pickups/${i}.svg)`}showFruit(e){this.points=e,this.animationTarget.style.backgroundImage=this.determineImage(this.type,e),this.animationTarget.classList.remove("pickup-hidden"),this.animationTarget.classList.add("pickup-visible")}hideFruit(){this.animationTarget.classList.remove("pickup-visible"),this.animationTarget.classList.add("pickup-hidden")}checkForCollision(e,t){const i=Object.assign({},t);return i.x+=.25*i.size,i.y+=.25*i.size,i.size/=2,e.x<i.x+i.size&&e.x+e.size>i.x&&e.y<i.y+i.size&&e.y+e.size>i.y}checkPacmanProximity(e,t,i){if(!this.animationTarget.classList.contains("pickup-hidden")){const s=Math.sqrt((this.center.x-t.x)**2+(this.center.y-t.y)**2);this.nearPacman=s<=e,i&&(this.animationTarget.style.background=this.nearPacman?"lime":"red")}}shouldCheckForCollision(){return!this.animationTarget.classList.contains("pickup-hidden")&&this.nearPacman}update(){this.shouldCheckForCollision()&&this.checkForCollision({x:this.x,y:this.y,size:this.size},{x:this.pacman.position.left,y:this.pacman.position.top,size:this.pacman.measurement})&&(this.animationTarget.classList.remove("pickup-visible"),this.animationTarget.classList.add("pickup-hidden"),window.dispatchEvent(new CustomEvent("awardPoints",{detail:{points:this.points,type:this.type}})),"pacdot"===this.type?window.dispatchEvent(new Event("dotEaten")):"powerPellet"===this.type&&(window.dispatchEvent(new Event("dotEaten")),window.dispatchEvent(new Event("powerUp"))))}}class CharacterUtil{constructor(e){this.scaledTileSize=e,this.threshold=5*this.scaledTileSize,this.directions={up:"up",down:"down",left:"left",right:"right"}}checkForStutter(e,t){let i=!1;return e&&t&&(Math.abs(e.top-t.top)>this.threshold||Math.abs(e.left-t.left)>this.threshold)&&(i=!0),i?"hidden":"visible"}getPropertyToChange(e){switch(e){case this.directions.up:case this.directions.down:return"top";default:return"left"}}getVelocity(e,t){switch(e){case this.directions.up:case this.directions.left:return-1*t;default:return t}}calculateNewDrawValue(e,t,i,s){return i[t]+(s[t]-i[t])*e}determineGridPosition(e,t){return{x:e.left/t+.5,y:e.top/t+.5}}turningAround(e,t){return t===this.getOppositeDirection(e)}getOppositeDirection(e){switch(e){case this.directions.up:return this.directions.down;case this.directions.down:return this.directions.up;case this.directions.left:return this.directions.right;default:return this.directions.left}}determineRoundingFunction(e){switch(e){case this.directions.up:case this.directions.left:return Math.floor;default:return Math.ceil}}changingGridPosition(e,t){return Math.floor(e.x)!==Math.floor(t.x)||Math.floor(e.y)!==Math.floor(t.y)}checkForWallCollision(e,t,i){const s=this.determineRoundingFunction(i,this.directions),n=s(e.x),a=s(e.y);let o;return Array.isArray(t[a])&&(o=t[a][n]),"X"===o}determineNewPositions(e,t,i,s,n){const a=Object.assign({},e);a[this.getPropertyToChange(t)]+=this.getVelocity(t,i)*s;return{newPosition:a,newGridPosition:this.determineGridPosition(a,n)}}snapToGrid(e,t,i){const s=Object.assign({},e),n=this.determineRoundingFunction(t,this.directions);switch(t){case this.directions.up:case this.directions.down:s.y=n(s.y);break;default:s.x=n(s.x)}return{top:(s.y-.5)*i,left:(s.x-.5)*i}}handleWarp(e,t,i){const s=Object.assign({},e),n=this.determineGridPosition(e,t);return n.x<-.75?s.left=t*(i[0].length-.75):n.x>i[0].length-.25&&(s.left=-1.25*t),s}advanceSpriteSheet(e){const{msSinceLastSprite:t,animationTarget:i,backgroundOffsetPixels:s}=e,n={msSinceLastSprite:t,animationTarget:i,backgroundOffsetPixels:s};if(e.msSinceLastSprite>e.msBetweenSprites&&e.animate){n.msSinceLastSprite=0,e.backgroundOffsetPixels<e.measurement*(e.spriteFrames-1)?n.backgroundOffsetPixels+=e.measurement:e.loopAnimation&&(n.backgroundOffsetPixels=0);const t=`-${n.backgroundOffsetPixels}px 0px`;n.animationTarget.style.backgroundPosition=t}return n}}class SoundManager{constructor(){this.baseUrl="app/style/audio/",this.fileFormat="mp3",this.masterVolume=1,this.paused=!1,this.cutscene=!0;const e=window.AudioContext||window.webkitAudioContext;this.ambience=new e}setCutscene(e){this.cutscene=e}setMasterVolume(e){this.masterVolume=e,this.soundEffect&&(this.soundEffect.volume=this.masterVolume),this.dotPlayer&&(this.dotPlayer.volume=this.masterVolume),0===this.masterVolume?this.stopAmbience():this.resumeAmbience(this.paused)}play(e){this.soundEffect=new Audio(`${this.baseUrl}${e}.${this.fileFormat}`),this.soundEffect.volume=this.masterVolume,this.soundEffect.play()}playDotSound(){this.queuedDotSound=!0,this.dotPlayer||(this.queuedDotSound=!1,this.dotSound=1===this.dotSound?2:1,this.dotPlayer=new Audio(`${this.baseUrl}dot_${this.dotSound}.${this.fileFormat}`),this.dotPlayer.onended=this.dotSoundEnded.bind(this),this.dotPlayer.volume=this.masterVolume,this.dotPlayer.play())}dotSoundEnded(){this.dotPlayer=void 0,this.queuedDotSound&&this.playDotSound()}async setAmbience(e,t){if(!this.fetchingAmbience&&!this.cutscene&&(t?this.paused=!0:(this.currentAmbience=e,this.paused=!1),this.ambienceSource&&this.ambienceSource.stop(),0!==this.masterVolume)){this.fetchingAmbience=!0;const t=await fetch(`${this.baseUrl}${e}.${this.fileFormat}`),i=await t.arrayBuffer(),s=await this.ambience.decodeAudioData(i);this.ambienceSource=this.ambience.createBufferSource(),this.ambienceSource.buffer=s,this.ambienceSource.connect(this.ambience.destination),this.ambienceSource.loop=!0,this.ambienceSource.start(),this.fetchingAmbience=!1}}resumeAmbience(e){this.ambienceSource&&(e?this.setAmbience("pause_beat",!0):this.setAmbience(this.currentAmbience))}stopAmbience(){this.ambienceSource&&this.ambienceSource.stop()}}class Timer{constructor(e,t){this.callback=e,this.remaining=t,this.resume()}pause(e){window.clearTimeout(this.timerId),this.remaining-=new Date-this.start,this.oldTimerId=this.timerId,e&&(this.pausedBySystem=!0)}resume(e){!e&&this.pausedBySystem||(this.pausedBySystem=!1,this.start=new Date,this.timerId=window.setTimeout((()=>{this.callback(),window.dispatchEvent(new CustomEvent("removeTimer",{detail:{timer:this}}))}),this.remaining),this.oldTimerId||window.dispatchEvent(new CustomEvent("addTimer",{detail:{timer:this}})))}}